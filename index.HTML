<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英語學習終端 - 劍橋繁中連動版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js'></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background: #f8fafc; color: #334155; }
        
        .highlight-word { 
            color: #991b1b !important; 
            font-weight: 800 !important; 
            text-decoration: underline;
            text-underline-offset: 3px;
        }

        .card-anim { animation: fadeInUp 0.4s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body class="p-4 md:p-10">
    <div class="max-w-5xl mx-auto">
        <div class="bg-white rounded-[2rem] shadow-sm border border-slate-200 p-8 mb-10">
            <h1 class="text-2xl font-black text-slate-800 mb-6 flex items-center gap-3">
                <i class="fa-solid fa-terminal text-slate-400"></i> 英語學習終端
            </h1>

            <div class="relative">
                <textarea id="batchInput" class="w-full h-44 p-6 bg-slate-50 rounded-2xl border-none focus:ring-2 focus:ring-slate-200 outline-none text-lg transition-all" placeholder="貼上英文內容或截圖..."></textarea>
                <div id="ocrStatus" class="hidden absolute inset-0 bg-white/90 rounded-2xl flex items-center justify-center font-bold text-slate-600 z-20">
                    <i class="fa-solid fa-circle-notch animate-spin mr-3"></i> 辨識圖片文字中...
                </div>
            </div>

            <div class="mt-6 flex justify-between items-center">
                <button onclick="processBatch()" id="mainBtn" class="bg-slate-900 text-white px-10 py-4 rounded-2xl font-bold hover:bg-red-900 transition-all shadow-lg flex items-center gap-2">
                    開始批次解析
                </button>
                <div class="flex items-center gap-6">
                    <div class="text-slate-400 text-sm cursor-pointer font-bold hover:text-slate-600 transition" onclick="toggleHistory()">
                        <i class="fa-solid fa-clock-rotate-left"></i> 歷史紀錄 (<span id="historyCount">0</span>)
                    </div>
                </div>
            </div>
        </div>

        <div id="historyDrawer" class="hidden grid grid-cols-2 md:grid-cols-4 gap-3 mb-10 p-6 bg-slate-100/50 rounded-3xl border border-slate-200"></div>

        <div id="resultsGrid" class="space-y-8 pb-32"></div>
    </div>

    <script>
        const synth = window.speechSynthesis;
        let history = JSON.parse(localStorage.getItem('vocab_v4_history')) || [];

        function speak(text) {
            if (synth.speaking) synth.cancel();
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = 'en-US';
            utter.rate = 0.9;
            synth.speak(utter);
        }

        document.addEventListener('paste', async (e) => {
            const item = Array.from(e.clipboardData.items).find(x => x.type.indexOf('image') !== -1);
            if (item) {
                const status = document.getElementById('ocrStatus');
                status.classList.remove('hidden');
                try {
                    const result = await Tesseract.recognize(item.getAsFile(), 'eng');
                    document.getElementById('batchInput').value += " " + result.data.text;
                } catch (err) { alert("OCR Failed"); }
                status.classList.add('hidden');
            }
        });

        async function processBatch() {
            const text = document.getElementById('batchInput').value.trim();
            if (!text) return;

            const words = [...new Set(text.match(/[a-zA-Z]+/g))].filter(w => w.length > 2);
            const grid = document.getElementById('resultsGrid');
            const btn = document.getElementById('mainBtn');

            grid.innerHTML = '';
            btn.disabled = true;
            btn.innerText = "正在解析中...";

            for (const word of words) {
                try {
                    const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word.toLowerCase()}`);
                    if (res.ok) {
                        const data = await res.json();
                        renderCard(data[0]);
                        saveToHistory(data[0]);
                    }
                } catch (e) {}
                await new Promise(r => setTimeout(r, 100)); 
            }
            btn.disabled = false;
            btn.innerText = "開始批次解析";
        }

        function highlightWord(sentence, word) {
            const regex = new RegExp(`(${word})`, 'gi');
            return sentence.replace(regex, `<span class="highlight-word">$1</span>`);
        }

        function renderCard(data) {
            const grid = document.getElementById('resultsGrid');
            const card = document.createElement('div');
            card.className = "card-anim bg-white rounded-[2.5rem] p-8 shadow-sm border border-slate-200 flex flex-col md:flex-row gap-8";
            
            // 構建劍橋繁體中文連結
            const cambridgeUrl = `https://dictionary.cambridge.org/zht/詞典/英語-漢語-繁體/${data.word}`;

            const meanings = data.meanings.slice(0, 2).map(m => {
                const def = m.definitions[0];
                return `
                    <div class="mb-6 last:mb-0">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-[10px] font-black bg-slate-100 text-slate-500 px-2 py-0.5 rounded uppercase tracking-widest">${m.partOfSpeech}</span>
                        </div>
                        <p class="text-slate-700 text-base leading-relaxed mb-4 font-medium">${def.definition}</p>
                        ${def.example ? `
                            <div class="bg-slate-50 p-5 rounded-2xl flex justify-between items-start gap-4 group border border-slate-100">
                                <p class="text-sm text-slate-500 italic font-serif leading-relaxed">
                                    "${highlightWord(def.example, data.word)}"
                                </p>
                                <button onclick="speak('${def.example.replace(/'/g, "\\'")}')" class="text-slate-300 group-hover:text-red-800 transition">
                                    <i class="fa-solid fa-volume-high text-sm"></i>
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            card.innerHTML = `
                <div class="md:w-1/3 md:border-r border-slate-100 md:pr-8">
                    <div class="flex items-center gap-3 mb-1">
                        <h2 class="text-3xl font-black text-slate-800 capitalize tracking-tighter">${data.word}</h2>
                        <button onclick="speak('${data.word}')" class="text-slate-300 hover:text-red-800 transition text-xl"><i class="fa-solid fa-circle-play"></i></button>
                    </div>
                    <p class="text-sm text-slate-400 font-mono mb-4">${data.phonetic || ''}</p>
                    <div class="flex flex-wrap gap-2 pt-2 border-t border-slate-50">
                         ${data.meanings.map(m => `<span class="text-[9px] font-bold text-slate-400 uppercase">${m.partOfSpeech}</span>`).join(' ')}
                    </div>
                </div>
                <div class="md:w-2/3">
                    ${meanings}
                    <div class="mt-4 text-right">
                        <a href="${cambridgeUrl}" target="_blank" class="text-[11px] text-red-800 hover:text-slate-900 underline underline-offset-4 uppercase font-black tracking-tight">
                            <i class="fa-solid fa-external-link mr-1"></i> Cambridge 劍橋繁中辭典
                        </a>
                    </div>
                </div>
            `;
            grid.prepend(card);
        }

        function saveToHistory(data) {
            if (history.find(h => h.word === data.word)) return;
            history.unshift(data);
            if (history.length > 40) history.pop();
            localStorage.setItem('vocab_v4_history', JSON.stringify(history));
            updateHistoryCount();
        }

        function updateHistoryCount() {
            document.getElementById('historyCount').innerText = history.length;
        }

        function toggleHistory() {
            const drawer = document.getElementById('historyDrawer');
            drawer.classList.toggle('hidden');
            if (!drawer.classList.contains('hidden')) {
                drawer.innerHTML = history.map(h => `
                    <div class="bg-white p-3 rounded-xl border border-slate-200 cursor-pointer hover:border-slate-800 transition text-center" onclick='renderCard(${JSON.stringify(h).replace(/'/g, "&apos;")})'>
                        <p class="font-bold text-slate-700 text-sm">${h.word}</p>
                    </div>
                `).join('') + `<div class="col-span-full text-center mt-4"><button onclick="clearHistory()" class="text-[10px] text-red-400 font-bold uppercase underline">清空紀錄</button></div>`;
            }
        }

        function clearHistory() {
            history = []; localStorage.removeItem('vocab_v4_history');
            updateHistoryCount(); toggleHistory();
        }

        updateHistoryCount();
    </script>
</body>
</html>